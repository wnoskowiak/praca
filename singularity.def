Bootstrap: docker
From: archlinux:latest

%post
    # Update and install dependencies
    pacman -Syu --noconfirm

    pacman -S --noconfirm \
        base-devel \
        wget \
        curl \
        git \
        openssl \
        libffi \
        openmpi \
        mariadb-clients \
        hdf5-openmpi \
        zlib \
        zlib-devel \
        bzip2 \
        bzip2-devel \
        readline \
        readline-devel \
        sqlite \
        sqlite-devel \
        openssl-devel \
        tk-devel \
        libffi-devel \
        xz-devel

    # Install pyenv
    curl https://pyenv.run | bash

    # Set environment variables for pyenv
    export PATH="/root/.pyenv/bin:$PATH"
    eval "$(pyenv init --path)"
    eval "$(pyenv init -)"
    eval "$(pyenv virtualenv-init -)"

    # Install Python 3.7.12 using pyenv
    pyenv install 3.7.12
    pyenv global 3.7.12

    # Upgrade pip
    pip install --upgrade pip

    # Install mpi4py first
    pip install mpi4py

    # Install h5py with MPI support
    # HDF5_MPI="ON" CC=mpicc HDF5_DIR=/usr/lib pip install --no-binary=h5py h5py

    # Install other specified Python packages
    pip install scipy jupyter matplotlib plotly pandas scikit-image particle pynuml==0.1

%environment
    # Set environment variables
    export PATH="/root/.pyenv/versions/3.7.12/bin:$PATH"
    export LD_LIBRARY_PATH=/usr/local/lib:/usr/lib:$LD_LIBRARY_PATH

%runscript
    # Define the default command to run
    exec python "$@"

%labels
    Author Wojciech Noskowiak
    Version 1.0
    Description Singularity container with Python 3.7, MPI, and specified Python packages