Bootstrap: docker
From: archlinux:latest

%post
    # Update and install dependencies
    pacman -Syu --noconfirm

    pacman -S --noconfirm \
        base-devel \
        wget \
        curl \
        git \
        openssl \
        libffi \
        openmpi \
        mariadb-clients \
        hdf5-openmpi \
        go \
        sudo

    # Create a non-root user
    useradd -m -s /bin/bash builduser
    echo "builduser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

    # Switch to the non-root user
    su - builduser <<EOF

    # Install yay
    git clone https://aur.archlinux.org/yay.git /opt/yay
    cd /opt/yay
    makepkg -si --noconfirm

    # Install python37 using yay
    yay -S --noconfirm python37

    # Create a virtual environment
    python3.7 -m venv /opt/venv

    # Activate the virtual environment
    source /opt/venv/bin/activate

    # Upgrade pip within the virtual environment
    /opt/venv/bin/pip install --upgrade pip

    # Install mpi4py first
    /opt/venv/bin/pip install mpi4py

    # Install h5py with MPI support
    # HDF5_MPI="ON" CC=mpicc HDF5_DIR=/usr/lib /opt/venv/bin/pip install --no-binary=h5py h5py

    # Install other specified Python packages
    /opt/venv/bin/pip install scipy jupyter matplotlib plotly pandas scikit-image particle pynuml==0.1

%environment
    # Set environment variables
    export PATH=/opt/venv/bin:$PATH
    export LD_LIBRARY_PATH=/usr/local/lib:/usr/lib:$LD_LIBRARY_PATH

%runscript
    # Define the default command to run
    exec python "$@"

%labels
    Author Wojciech Noskowiak
    Version 1.0
    Description Singularity container with Python 3.7, MPI, and specified Python packages